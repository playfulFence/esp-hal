name: HIL

on:
  # For merge queue: always run full matrix on the merge commit
  merge_group:
  workflow_dispatch:
    inputs:
      repository:
        description: "Owner/repository to test (for dispatched runs)"
        required: false
        default: ""
        type: string
      branch:
        description: "Ref (branch/tag/SHA) to checkout"
        required: false
        default: ""
        type: string
      matrix:
        description: "Test matrix size: quick|full"
        required: false
        default: "quick"
        type: string
      pr_number:
        description: "PR number (for naming and cross-linking)"
        required: false
        default: ""
        type: string

run-name: HIL${{ inputs.pr_number && format(' for PR #{0}', inputs.pr_number) }}

concurrency:
  cancel-in-progress: true
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}

env:
  CARGO_TERM_COLOR: always
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build-xtasks:
    name: Build xtasks
    runs-on: ubuntu-latest

    env:
      HIL_REPO:   ${{ inputs.repository != '' && inputs.repository || github.repository }}
      HIL_BRANCH: ${{ inputs.branch    != '' && inputs.branch    || github.ref }}

    steps:
      # merge_group checks out the merge commit implicitly
      - uses: actions/checkout@v4
        if: github.event_name == 'merge_group'

      - uses: actions/checkout@v4
        if: github.event_name == 'workflow_dispatch'
        with:
          repository: ${{ env.HIL_REPO }}
          ref:        ${{ env.HIL_BRANCH }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: rust-src

      - name: Install cross
        run: cargo install cross

      - name: Build xtasks
        run: |
          cross build --release --target armv7-unknown-linux-gnueabihf -p xtask
          cross build --release --target aarch64-unknown-linux-gnu -p xtask

      - name: Upload artifact | armv7-unknown-linux-gnueabihf
        uses: actions/upload-artifact@v4
        with:
          name: xtask-armv7
          path: target/armv7-unknown-linux-gnueabihf/release/xtask

      - name: Upload artifact | aarch64-unknown-linux-gnu
        uses: actions/upload-artifact@v4
        with:
          name: xtask-aarch64
          path: target/aarch64-unknown-linux-gnu/release/xtask

  build-tests-full:
    # full matrix for merge_group OR when matrix == 'full' in dispatched runs
    if: github.event_name == 'merge_group' || inputs.matrix == 'full'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
        - soc: esp32c2
          rust-target: riscv32imc-unknown-none-elf
          runner: esp32c2-jtag
          host: aarch64
        - soc: esp32c3
          rust-target: riscv32imc-unknown-none-elf
          runner: esp32c3-usb
          host: armv7
        - soc: esp32c6
          rust-target: riscv32imac-unknown-none-elf
          runner: esp32c6-usb
          host: armv7
        - soc: esp32h2
          rust-target: riscv32imac-unknown-none-elf
          runner: esp32h2-usb
          host: armv7
        - soc: esp32
          rust-target: xtensa-esp32-none-elf
          runner: esp32-jtag
          host: aarch64
        - soc: esp32s2
          rust-target: xtensa-esp32s2-none-elf
          runner: esp32s2-jtag
          host: armv7
        - soc: esp32s3
          rust-target: xtensa-esp32s3-none-elf
          runner: esp32s3-usb
          host: armv7
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/build-tests
        with:
          event_name:  ${{ github.event_name }}
          repository:  ${{ inputs.repository != '' && inputs.repository || github.repository }}
          branch:      ${{ inputs.branch    != '' && inputs.branch    || github.ref }}
          soc:         ${{ matrix.target.soc }}
          rust_target: ${{ matrix.target.rust-target }}

  build-tests-quick:
    # quick matrix only for non-merge_group and when matrix != 'full'
    if: github.event_name != 'merge_group' && inputs.matrix != 'full'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - soc: esp32c3
            rust-target: riscv32imc-unknown-none-elf
            runner: esp32c3-usb
            host: armv7
          - soc: esp32s3
            rust-target: xtensa-esp32s3-none-elf
            runner: esp32s3-usb
            host: armv7
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/build-tests
        with:
          event_name:  ${{ github.event_name }}
          repository:  ${{ inputs.repository != '' && inputs.repository || github.repository }}
          branch:      ${{ inputs.branch    != '' && inputs.branch    || github.ref }}
          soc:         ${{ matrix.target.soc }}
          rust_target: ${{ matrix.target.rust-target }}

  hil-quick:
    if: github.event_name != 'merge_group' && inputs.matrix != 'full'
    needs: [build-tests-quick, build-xtasks]
    runs-on:
      labels: [self-hosted, "${{ matrix.target.runner }}"]
    strategy:
      fail-fast: false
      matrix:
        target:
          - soc: esp32c3
            rust-target: riscv32imc-unknown-none-elf
            runner: esp32c3-usb
            host: armv7
          - soc: esp32s3
            rust-target: xtensa-esp32s3-none-elf
            runner: esp32s3-usb
            host: armv7
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: tests-${{ matrix.target.soc }}
          path: tests-${{ matrix.target.soc }}
        continue-on-error: true

      - uses: actions/download-artifact@v4
        with:
          name: xtask-${{ matrix.target.host }}

      - name: Skip if this target wasn't built
        id: guard
        run: |
          if [ ! -d "tests-${{ matrix.target.soc }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "No tests for ${{ matrix.target.soc }} in this run; skipping."
          fi

      - name: Run Tests
        if: steps.guard.outputs.skip != 'true'
        id: run-tests
        run: |
          [ -f ~/setup.sh ] && source ~/setup.sh
          export PATH=$PATH:/home/espressif/.cargo/bin
          chmod +x xtask
          ./xtask run elfs ${{ matrix.target.soc }} tests-${{ matrix.target.soc }}

      - name: Clean up
        if: always()
        run: |
          rm -rf tests-${{ matrix.target.soc }} || true
          rm -f xtask || true

  hil-full:
    if: github.event_name == 'merge_group' || inputs.matrix == 'full'
    needs: [build-tests-full, build-xtasks]
    runs-on:
      labels: [self-hosted, "${{ matrix.target.runner }}"]
    strategy:
      fail-fast: false
      matrix:
        target:
        - soc: esp32c2
          rust-target: riscv32imc-unknown-none-elf
          runner: esp32c2-jtag
          host: aarch64
        - soc: esp32c3
          rust-target: riscv32imc-unknown-none-elf
          runner: esp32c3-usb
          host: armv7
        - soc: esp32c6
          rust-target: riscv32imac-unknown-none-elf
          runner: esp32c6-usb
          host: armv7
        - soc: esp32h2
          rust-target: riscv32imac-unknown-none-elf
          runner: esp32h2-usb
          host: armv7
        - soc: esp32
          rust-target: xtensa-esp32-none-elf
          runner: esp32-jtag
          host: aarch64
        - soc: esp32s2
          rust-target: xtensa-esp32s2-none-elf
          runner: esp32s2-jtag
          host: armv7
        - soc: esp32s3
          rust-target: xtensa-esp32s3-none-elf
          runner: esp32s3-usb
          host: armv7
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: tests-${{ matrix.target.soc }}
          path: tests-${{ matrix.target.soc }}
        continue-on-error: true

      - uses: actions/download-artifact@v4
        with:
          name: xtask-${{ matrix.target.host }}

      - name: Skip if this target wasn't built
        id: guard
        run: |
          if [ ! -d "tests-${{ matrix.target.soc }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "No tests for ${{ matrix.target.soc }} in this run; skipping."
          fi

      - name: Run Tests
        if: steps.guard.outputs.skip != 'true'
        id: run-tests
        run: |
          [ -f ~/setup.sh ] && source ~/setup.sh
          export PATH=$PATH:/home/espressif/.cargo/bin
          chmod +x xtask
          ./xtask run elfs ${{ matrix.target.soc }} tests-${{ matrix.target.soc }}

      - name: Clean up
        if: always()
        run: |
          rm -rf tests-${{ matrix.target.soc }} || true
          rm -f xtask || true

  required:
    if: github.event_name == 'merge_group'
    needs: [hil-full]
    runs-on: ubuntu-latest
    steps:
      - run: echo "All HIL matrix jobs passed on merge_group."
